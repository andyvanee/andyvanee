<!DOCTYPE html>
<html>
  <head>
    <title>andyvanee.com - Assembly Language For Mac</title>
    <link href="http://fonts.googleapis.com/css?family=Rokkitt:700|Cantarell:400,700,400italic" rel="stylesheet" type="text/css">
    <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/css/a.css" rel="stylesheet" type="text/css">
    <link rel="alternate" type="application/rss+xml" title="andyvanee.com feed" href="http://andyvanee.com/feed.xml" />
    <meta name="description" content="Thoughts on Programming, Metaphysics, and anything in between">
  </head>
  <body>
  <div class="container">
    <div class="row">
      <div class="span8">
        <h1 class="page-title"><a href="/">andyvanee</a><span class="subhead">blog</span></h1>
      </div>
      <div class="span8">
        <div class="post-single">
  <h2>
    <a href="/2010/03/03/assembly-language-for-mac.html">Assembly Language For Mac</a>
    <span class="date">03-Mar-2010</span>
  </h2>
  <p>I&#8217;m away from my Linux box and want to do some assembly programming. Mac installs GCC with the developer tools, but there are enough differences that I haven&#8217;t bothered to work through them until now. Here&#8217;s <a href='http://shorestreet.com/node/21'>a decent tutorial</a>, although it focuses on PPC assembly and I&#8217;m using an Intel Mac. The thing that frightened me about the Mac assembler was the default output of gcc -S. There is some strange optimizations and flags in the resulting assembly code. The key, as the tutorial points out, is in the compiler options. Here&#8217;s what I used on the ubiquitous &#8220;Hello World&#8221; program:</p>

<pre><code>gcc -S -fno-PIC -O2 -Wall -o hello.s hello.c</code></pre>

<p>And here&#8217;s the assembly code it spit out:</p>

<pre><code>.cstring
LC0:
   .ascii &quot;Hello World!%d\12\0&quot;
   .text
   .align 4,0x90

.globl _main
   _main:
   pushl   %ebp
   movl    %esp, %ebp
   subl    $24, %esp
   movl    $12, 4(%esp)
   movl    $LC0, (%esp)
   call    _printf
   xorl    %eax, %eax
   leave
   ret
   .subsections_via_symbols</code></pre>

<p>This is more familiar territory, the only differences being the <code>.cstring</code> directive instead of <code>.section .text</code>, the leading underscore on printf, and the <code>.subsections_via_symbols</code> directive. The general naming of sections is outlined on the Mac Assembler Reference, and the <code>.subsections_via_symbols</code> explanation is interesting. I&#8217;m already used to using many labels in my code; does this mean that the named sections would be ripped out because they are not &#8220;called&#8221; by any other code? I tested this out in the previous example, just adding a second call to <code>_printf</code> in a labelled section and the code worked just fine. It seems that labels don&#8217;t count, they have to be declared sections like <code>.globl</code>, <code>.section</code> or whatever. That seems fair, I haven&#8217;t yet made a habit of calling sections that are supposed to flow naturally into other sections. Maybe there is some instance where this might be a useful optimization? I will be looking into Position Independent Code(PIC) a bit more, it seems that it&#8217;s similar in theory to how the latest Linux kernel runs code at randomized memory locations to prevent hardcoded attacks, but I don&#8217;t know if that&#8217;s the extent of it.</p>
</div>
<p>
    tags:
    
    <a class="badge badge-info" href="/tag/Programming/">
        Programming
    </a>
    
    <a class="badge badge-info" href="/tag/Assembly/">
        Assembly
    </a>
    
</p>
<p class="well">
    <a href="mailto:andy@andyvanee.com?subject=Comments%20on%3A%20Assembly Language For Mac">
        Email
    </a>
    your comments to me. I will try to respond to all comments either by revising the
    post, or by responding personally. I promise not post or otherwise mishandle
    your email address.
</p>
      </div>
      <div class="span8 footer">
        <div class="inside">
          <p><a href="/">andyvanee.com</a> | <a href="https://github.com/Andyvanee/andyvanee.github.com/wiki">wiki</a></p>
        </div>
      </div>
    </div>
  </body>
  <script type="text/javascript" charset="utf-8" src="/js/jquery.min.js"></script>
  <script type="text/javascript" charset="utf-8" src="/js/app.min.js"></script>
</html>
